<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#0d0d1a"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Math Saga Game For Kids</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Syne:wght@700;800&family=Syne+Mono&display=swap" rel="stylesheet"/>
<style>
:root{
  --ink:#070710; --deep:#0d0d1a; --surface:#141428;
  --card:#1c1c35; --raised:#232342;
  --border:rgba(255,255,255,0.07); --border-md:rgba(255,255,255,0.14);
  --cyan:#00e5ff; --violet:#7c3aff; --magenta:#ff2d78;
  --gold:#ffb800; --lime:#00ff87; --coral:#ff5c4d;
  --correct:#00ff87; --wrong:#ff3b5c;
  --text:#f0f0ff; --text-mid:#a0a0c0; --text-dim:#505075;
  --fd:'Syne',sans-serif; --fm:'Syne Mono',monospace; --fb:'Space Grotesk',sans-serif;
  --r:16px; --rlg:24px; --rxl:32px;
  --topbar-h: 56px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;width:100%;background:var(--ink);color:var(--text);
  font-family:var(--fb);overflow:hidden;-webkit-tap-highlight-color:transparent;user-select:none}
button{cursor:pointer;border:none;background:none;font-family:inherit;color:inherit}

body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 130% 80% at 15% -5%,rgba(124,58,255,.13) 0%,transparent 55%),
             radial-gradient(ellipse 80% 60% at 85% 105%,rgba(0,229,255,.08) 0%,transparent 55%)}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(255,255,255,.012) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(255,255,255,.012) 1px,transparent 1px);
  background-size:60px 60px}

/* ‚îÄ‚îÄ FIXED TOP BAR (home only) ‚îÄ‚îÄ */
#home-topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: var(--topbar-h);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
  background: rgba(7,7,16,0.85);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
}
#home-topbar.hidden-bar { display: none; }
.topbar-title {
  font-family: var(--fd);
  font-size: 20px;
  font-weight: 800;
  letter-spacing: 3px;
  text-transform: uppercase;
  background: linear-gradient(135deg, #fff 0%, var(--cyan) 55%, var(--violet) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* SCREENS ‚Äî only .active is shown */
.screen{display:none;position:fixed;inset:0;flex-direction:column;align-items:center;z-index:10}
.screen.active{display:flex}
#home,#result{overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;justify-content:flex-start}
#home::-webkit-scrollbar,#result::-webkit-scrollbar{display:none}

/* HOME ‚Äî pad top for fixed bar */
.home-inner{
  width:100%;max-width:440px;
  padding: calc(var(--topbar-h) + 8px) 20px 48px;
  display:flex;flex-direction:column;align-items:center;min-height:100%
}

/* hero ‚Äî remove the big logo title area, keep the glow mark smaller */
.hero{width:100%;padding:24px 0 20px;display:flex;flex-direction:column;align-items:center;position:relative}
.hero-glow{position:absolute;width:200px;height:200px;border-radius:50%;top:-30px;left:50%;
  transform:translateX(-50%);pointer-events:none;
  background:radial-gradient(circle,rgba(124,58,255,.14) 0%,transparent 70%)}
.logo-mark{width:64px;height:64px;border-radius:18px;
  background:linear-gradient(135deg,var(--violet),var(--cyan));
  display:flex;align-items:center;justify-content:center;
  font-size:30px;margin-bottom:10px;position:relative;z-index:1;
  box-shadow:0 0 30px rgba(124,58,255,.4),0 16px 32px rgba(0,0,0,.35);
  animation:float 4s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.logo-tag{font-size:10px;letter-spacing:5px;color:var(--text-dim);text-transform:uppercase;
  margin-top:2px;font-weight:500;position:relative;z-index:1}

.stats-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;margin-bottom:24px}
.sc{background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:14px 8px 12px;text-align:center}
.sc-val{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold);line-height:1}
.sc-lbl{font-size:10px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-top:4px;font-weight:500}

.sect{width:100%;display:flex;align-items:center;gap:10px;margin-bottom:12px}
.sect-line{flex:1;height:1px;background:var(--border)}
.sect-lbl{font-size:10px;letter-spacing:4px;color:var(--text-dim);text-transform:uppercase;font-weight:600;white-space:nowrap}

.daily{width:100%;display:flex;align-items:center;gap:14px;padding:16px;border-radius:var(--r);
  background:linear-gradient(135deg,rgba(255,184,0,.07),rgba(255,45,120,.07));
  border:1.5px solid rgba(255,184,0,.2);margin-bottom:24px;cursor:pointer;transition:transform .15s}
.daily:active{transform:scale(.98)}
.daily-icon{font-size:30px;flex-shrink:0}
.daily-title{font-family:var(--fd);font-size:14px;font-weight:700;color:var(--gold)}
.daily-sub{font-size:12px;color:var(--text-mid);margin-top:2px}
.daily-arr{margin-left:auto;font-size:18px;color:var(--gold);flex-shrink:0}

.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;margin-bottom:24px}
.mc{border-radius:var(--r);border:1.5px solid var(--border);background:var(--card);
  padding:16px 14px;display:flex;flex-direction:column;align-items:flex-start;
  transition:all .18s;position:relative;overflow:hidden;cursor:pointer}
.mc::before{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,var(--mc1,var(--violet)),var(--mc2,var(--cyan)));
  opacity:0;transition:opacity .18s}
.mc.sel{border-color:var(--mc1,var(--violet))}
.mc.sel::before{opacity:.09}
.mc:active{transform:scale(.95)}
.mc-icon{font-size:24px;margin-bottom:8px;position:relative;z-index:1}
.mc-name{font-family:var(--fd);font-size:14px;font-weight:700;position:relative;z-index:1;margin-bottom:2px}
.mc-desc{font-size:11px;color:var(--text-mid);position:relative;z-index:1;line-height:1.4}
.mc-badge{position:absolute;top:10px;right:10px;font-size:9px;padding:2px 7px;
  border-radius:20px;font-weight:700;letter-spacing:1px;z-index:1}

.diff-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:100%;margin-bottom:24px}
.db{aspect-ratio:1;border-radius:10px;border:1.5px solid var(--border);background:var(--card);
  font-family:var(--fd);font-size:16px;font-weight:700;color:var(--text-mid);
  transition:all .15s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px}
.db .dbar{width:55%;height:3px;border-radius:2px;background:var(--border);transition:background .15s}
.db.sel{border-color:var(--cyan);background:rgba(0,229,255,.08);color:var(--cyan);box-shadow:0 0 14px rgba(0,229,255,.2)}
.db.sel .dbar{background:var(--cyan)}
.db:active{transform:scale(.9)}

.ops-row{display:flex;gap:8px;width:100%;margin-bottom:28px}
.ot{flex:1;padding:12px 4px;border-radius:10px;border:1.5px solid var(--border);background:var(--card);
  font-size:17px;font-weight:700;color:var(--text-dim);transition:all .15s;text-align:center}
.ot.on{border-color:var(--violet);background:rgba(124,58,255,.1);color:var(--text);box-shadow:0 0 12px rgba(124,58,255,.2)}
.ot:active{transform:scale(.9)}

.cta{width:100%;padding:20px;border-radius:var(--rxl);font-family:var(--fd);font-size:17px;font-weight:800;
  letter-spacing:2px;background:linear-gradient(135deg,var(--violet),var(--cyan));color:#fff;
  box-shadow:0 0 40px rgba(124,58,255,.35),0 16px 40px rgba(0,0,0,.3);
  transition:transform .15s,box-shadow .15s;margin-bottom:24px;position:relative;overflow:hidden;display: flex;align-items: center;justify-content: center;text-align: center;}
.cta::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,.15);opacity:0;transition:opacity .12s}
.cta:active{transform:scale(.97)}.cta:active::after{opacity:1}

.lb-box{width:100%;background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:16px;margin-bottom:8px}
.lb-hd{font-size:10px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:12px;font-weight:600}
.lb-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)}
.lb-row:last-child{border-bottom:none}
.lb-rank{font-family:var(--fm);font-size:14px;color:var(--text-dim);width:24px;text-align:center}
.lb-rank.g{color:var(--gold)}
.lb-name{flex:1;font-size:14px;font-weight:600}
.lb-score{font-family:var(--fm);font-size:14px;color:var(--cyan);font-weight:700}

/* GAME */
#game{justify-content:flex-start}
.gh{width:100%;max-width:480px;padding:max(env(safe-area-inset-top,0px),16px) 20px 0;
  display:flex;align-items:center;gap:10px;margin-bottom:10px}
.gquit{width:38px;height:38px;border-radius:10px;border:1px solid var(--border);background:var(--card);
  font-size:16px;color:var(--text-mid);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.gquit:active{color:var(--wrong);border-color:var(--wrong)}
.gpills{display:flex;gap:6px;flex:1;justify-content:flex-end;flex-wrap:wrap}
.gp{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;
  border:1px solid var(--border);background:var(--surface);font-size:12px;font-weight:600}
.gpv{font-family:var(--fm);color:var(--cyan);font-size:13px;font-weight:700}
.gp.sp .gpv{color:var(--gold)}

.gbar{width:100%;max-width:480px;padding:0 20px;margin-bottom:10px}
.bmeta{display:flex;justify-content:space-between;font-size:11px;color:var(--text-dim);
  margin-bottom:5px;font-family:var(--fm)}
.btrack{height:5px;border-radius:3px;background:var(--raised);overflow:hidden}
.bfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--cyan),var(--violet));
  transition:width .08s linear;box-shadow:0 0 8px rgba(0,229,255,.5)}
.bfill.danger{background:linear-gradient(90deg,var(--wrong),var(--magenta));box-shadow:0 0 8px rgba(255,59,92,.5)}

.lives-row{display:none;width:100%;max-width:480px;padding:0 20px;margin-bottom:6px;font-size:22px}

.qzone{width:100%;max-width:480px;padding:0 20px;flex:1;display:flex;flex-direction:column;justify-content:center}
.qmeta{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.qchip{display:flex;align-items:center;gap:6px;padding:4px 12px 4px 8px;border-radius:20px;
  background:rgba(124,58,255,.12);border:1px solid rgba(124,58,255,.25);
  font-size:11px;font-weight:700;letter-spacing:2px;color:var(--violet);text-transform:uppercase}
.qdot{width:7px;height:7px;border-radius:50%;background:var(--violet);box-shadow:0 0 8px var(--violet)}
.qnum{font-family:var(--fm);font-size:12px;color:var(--text-dim);margin-left:auto}

.question{font-family:var(--fd);font-size:clamp(42px,12vw,68px);font-weight:800;
  line-height:1.05;letter-spacing:-2px;color:var(--text);margin-bottom:10px}
.question .qop{color:var(--magenta);font-size:.82em}
.question .qeq{color:var(--text-dim);font-size:.65em}
.question .qslot{color:var(--cyan);border-bottom:3px solid var(--cyan);padding-bottom:2px;
  min-width:55px;display:inline-block;text-align:center;animation:sp 1.3s ease-in-out infinite}
@keyframes sp{0%,100%{border-color:var(--cyan)}50%{border-color:rgba(0,229,255,.25)}}

.cbar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.clbl{font-size:10px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;font-weight:600;flex-shrink:0}
.cdots{display:flex;gap:5px}
.cd{width:8px;height:8px;border-radius:50%;background:var(--raised);transition:all .25s cubic-bezier(.34,1.56,.64,1)}
.cd.on{background:var(--gold);box-shadow:0 0 8px var(--gold);transform:scale(1.25)}
.cbonus{margin-left:auto;font-family:var(--fm);font-size:13px;color:var(--gold);font-weight:700;opacity:0;transition:opacity .2s}
.cbonus.show{opacity:1}

.ans-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;
  width:100%;max-width:480px;padding:0 20px;margin-bottom:16px}
.ans{height:80px;border-radius:var(--rlg);border:1.5px solid var(--border);background:var(--card);
  font-family:var(--fd);font-size:28px;font-weight:700;color:var(--text);
  transition:all .15s;position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center}
.ans::before{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,var(--ac1,var(--violet)),var(--ac2,var(--cyan)));
  opacity:0;transition:opacity .15s}
.ans-t{position:relative;z-index:1}
.ans:active:not([disabled]){transform:scale(.95)}
.ans:active:not([disabled])::before{opacity:.1}
.ans.correct{border-color:var(--correct)!important;background:rgba(0,255,135,.09)!important;
  box-shadow:0 0 28px rgba(0,255,135,.35)!important}
.ans.correct .ans-t{color:var(--correct)}
.ans.wrong{border-color:var(--wrong)!important;background:rgba(255,59,92,.09)!important;
  box-shadow:0 0 28px rgba(255,59,92,.3)!important}
.ans.wrong .ans-t{color:var(--wrong)}
.ans.reveal{border-color:rgba(0,255,135,.4);background:rgba(0,255,135,.05)}
.ans[disabled]{pointer-events:none}

/* RESULT */
.result-inner{width:100%;max-width:440px;padding:24px 20px 60px;
  display:flex;flex-direction:column;align-items:center;gap:14px;min-height:100%}
.rhero{width:100%;background:var(--card);border:1px solid var(--border);border-radius:var(--rxl);
  padding:32px 24px;text-align:center;position:relative;overflow:hidden}
.rhero::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 100% 60% at 50% 0%,rgba(124,58,255,.14) 0%,transparent 70%)}
.rtrophy{font-size:68px;display:block;margin-bottom:10px;position:relative;
  animation:trophyin .5s cubic-bezier(.34,1.56,.64,1)}
@keyframes trophyin{from{transform:scale(0) rotate(-15deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.rtitle{font-family:var(--fd);font-size:30px;font-weight:800;position:relative;
  background:linear-gradient(135deg,var(--gold),var(--magenta));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.rrecord{display:none;align-items:center;justify-content:center;
  padding:4px 12px;border-radius:20px;background:rgba(255,184,0,.1);border:1px solid rgba(255,184,0,.3);
  color:var(--gold);font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  margin-top:10px;animation:rp 1.2s ease-in-out infinite}
.rrecord.show{display:flex}
@keyframes rp{0%,100%{opacity:1}50%{opacity:.4}}
.rgrade{position:absolute;top:16px;right:20px;font-family:var(--fd);font-size:52px;font-weight:800;opacity:.08}

.rstats{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%}
.rs{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px 12px;text-align:center}
.rs.hi{border-color:rgba(255,184,0,.25);background:rgba(255,184,0,.04)}
.rsv{font-family:var(--fd);font-size:28px;font-weight:800;color:var(--cyan);line-height:1}
.rs.hi .rsv{color:var(--gold)}
.rsl{font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-top:5px;font-weight:600}

.xpcard{width:100%;background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px}
.xph{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.xplvl{font-family:var(--fd);font-size:14px;font-weight:700;color:var(--violet)}
.xpnxt{font-size:12px;color:var(--text-dim)}
.xptrack{height:8px;border-radius:4px;background:var(--raised);overflow:hidden;margin-bottom:6px}
.xpfill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--violet),var(--cyan));
  width:0%;transition:width 1.2s cubic-bezier(.4,0,.2,1);box-shadow:0 0 10px rgba(124,58,255,.4)}
.xpearned{font-size:11px;color:var(--cyan);font-weight:700;letter-spacing:1px}

.achrow{width:100%;display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
.achrow::-webkit-scrollbar{display:none}
.ach{flex-shrink:0;display:flex;align-items:center;gap:8px;padding:9px 13px;border-radius:10px;
  border:1.5px solid var(--gold);color:var(--gold);background:var(--card);
  font-size:12px;font-weight:600;white-space:nowrap;
  animation:chipIn .4s cubic-bezier(.34,1.56,.64,1) both}
@keyframes chipIn{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
.ach-icon{font-size:18px}

.bdown{width:100%;background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px}
.bdtitle{font-size:10px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:12px;font-weight:600}
.bdrow{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.bdrow:last-child{margin-bottom:0}
.bdicon{font-size:17px;width:26px;text-align:center}
.bdlbl{font-size:12px;font-weight:600;color:var(--text-mid);width:78px}
.bdtrack{flex:1;height:5px;border-radius:3px;background:var(--raised);overflow:hidden}
.bdfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--violet),var(--cyan));transition:width .7s ease}
.bdacc{font-family:var(--fm);font-size:12px;color:var(--text-dim);width:34px;text-align:right}

.rbtns{display:flex;gap:10px;width:100%}
.ragain{flex:2;padding:18px;border-radius:var(--rxl);font-family:var(--fd);font-size:15px;font-weight:800;
  letter-spacing:2px;background:linear-gradient(135deg,var(--violet),var(--cyan));color:#fff;
  box-shadow:0 0 30px rgba(124,58,255,.3);transition:transform .15s}
.ragain:active{transform:scale(.97)}
/* FIX: home button bigger */
.rhomebtn{flex:1;padding:18px;border-radius:var(--rxl);font-family:var(--fd);font-size:26px;font-weight:700;
  border:1.5px solid var(--border-md);background:var(--card);color:var(--text);transition:all .15s}
.rhomebtn:active{transform:scale(.97);border-color:var(--violet)}
.rshare{width:100%;padding:14px;border-radius:var(--rlg);font-family:var(--fd);font-size:13px;font-weight:700;
  letter-spacing:2px;border:1.5px solid rgba(0,229,255,.25);background:rgba(0,229,255,.05);
  color:var(--cyan);transition:transform .15s;display:flex;align-items:center;justify-content:center;gap:8px}
.rshare:active{transform:scale(.97)}

/* ONBOARD */
#onboard{position:fixed;inset:0;background:rgba(7,7,16,.94);backdrop-filter:blur(14px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;z-index:999}
#onboard.gone{display:none}
.obcard{width:100%;max-width:380px;background:var(--card);border:1px solid var(--border-md);
  border-radius:var(--rxl);padding:32px 26px;text-align:center}
.obstep{display:none;flex-direction:column;align-items:center;gap:14px}
.obstep.active{display:flex}
.obicon{font-size:54px}
.obtitle{font-family:var(--fd);font-size:24px;font-weight:800;line-height:1.2}
.obdesc{font-size:14px;color:var(--text-mid);line-height:1.65;max-width:280px}
.obdots{display:flex;gap:8px}
.oddot{width:8px;height:8px;border-radius:50%;background:var(--raised);transition:all .2s}
.oddot.on{background:var(--violet);box-shadow:0 0 8px var(--violet);transform:scale(1.3)}
.obbtn{width:100%;padding:16px;margin-top:6px;border-radius:var(--rlg);font-family:var(--fd);
  font-size:15px;font-weight:800;letter-spacing:2px;
  background:linear-gradient(135deg,var(--violet),var(--cyan));color:#fff;transition:transform .15s}
.obbtn:active{transform:scale(.97)}
.obskip{font-size:12px;color:var(--text-dim);margin-top:14px;cursor:pointer;letter-spacing:1px;
  text-decoration:underline;text-underline-offset:3px}

/* FX */
#flash{position:fixed;inset:0;pointer-events:none;z-index:300;display:none}
#flash.c{display:block;background:radial-gradient(circle,rgba(0,255,135,.12) 0%,transparent 70%);animation:ff .35s ease forwards}
#flash.w{display:block;background:radial-gradient(circle,rgba(255,59,92,.15) 0%,transparent 70%);animation:ff .35s ease forwards}
@keyframes ff{to{opacity:0}}
#particles{position:fixed;inset:0;pointer-events:none;z-index:400}
.pfly{position:absolute;border-radius:50%;animation:pf .7s ease-out forwards}
@keyframes pf{from{transform:translate(0,0) scale(1);opacity:1}to{transform:translate(var(--dx),var(--dy)) scale(0);opacity:0}}
.spop{position:fixed;left:50%;top:38%;
  font-family:var(--fd);font-size:30px;font-weight:800;color:var(--gold);
  text-shadow:0 0 40px var(--gold);pointer-events:none;z-index:600;white-space:nowrap;
  animation:spopa .75s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes spopa{0%{transform:translate(-50%,-50%) scale(.3);opacity:0}40%{transform:translate(-50%,-58%) scale(1.1);opacity:1}100%{transform:translate(-50%,-78%) scale(.85);opacity:0}}
.sfloat{position:fixed;font-family:var(--fd);font-size:20px;font-weight:800;color:var(--correct);
  pointer-events:none;z-index:500;text-shadow:0 0 16px var(--correct);
  animation:sfl .65s ease-out forwards}
@keyframes sfl{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-55px) scale(.8);opacity:0}}

@media(max-height:680px){
  .question{font-size:clamp(34px,10vw,52px)}
  .ans{height:66px;font-size:23px}
  .hero{padding:16px 0 12px}
  .logo-mark{width:52px;height:52px;font-size:24px}
}
</style>
</head>
<body>

<div id="flash"></div>
<div id="particles"></div>

<!-- FIXED TOP BAR ‚Äî always visible on home -->
<div id="home-topbar" class="hidden-bar">
  <div class="topbar-title">MATH SAGA</div>
</div>

<!-- ONBOARDING -->
<div id="onboard">
  <div class="obcard">
    <div class="obstep active" id="ob0">
      <div class="obicon">üßÆ</div>
      <div class="obtitle">Welcome to<br>Math Saga</div>
      <div class="obdesc">The most advanced math training game. Sharpen your mind, beat records, conquer every level.</div>
      <div class="obdots"><div class="oddot on"></div><div class="oddot"></div><div class="oddot"></div></div>
      <button class="obbtn" id="obn0">GET STARTED ‚Üí</button>
    </div>
    <div class="obstep" id="ob1">
      <div class="obicon">‚ö°</div>
      <div class="obtitle">Race the Clock</div>
      <div class="obdesc">Answer before time runs out. Build streaks for bonus XP. Hit 5 in a row to activate COMBO mode!</div>
      <div class="obdots"><div class="oddot"></div><div class="oddot on"></div><div class="oddot"></div></div>
      <button class="obbtn" id="obn1">NEXT ‚Üí</button>
    </div>
    <div class="obstep" id="ob2">
      <div class="obicon">üèÜ</div>
      <div class="obtitle">Master All Levels</div>
      <div class="obdesc">4 game modes, 10 difficulty levels, XP progression, achievements and daily challenges.</div>
      <div class="obdots"><div class="oddot"></div><div class="oddot"></div><div class="oddot on"></div></div>
      <button class="obbtn" id="obn2">LET'S GO ‚Üí</button>
    </div>
  </div>
  <div class="obskip" id="obskip">Skip intro</div>
</div>

<!-- HOME -->
<div class="screen" id="home">
  <div class="home-inner">
    <div class="hero">
      <div class="hero-glow"></div>
      <div class="logo-mark">‚àû</div>
      <div class="logo-tag">Master ¬∑ Compete ¬∑ Conquer</div>
    </div>

    <div class="stats-bar">
      <div class="sc"><div class="sc-val" id="h-best">0</div><div class="sc-lbl">Best üî•</div></div>
      <div class="sc"><div class="sc-val" id="h-solved">0</div><div class="sc-lbl">Solved</div></div>
      <div class="sc"><div class="sc-val" id="h-xp">0</div><div class="sc-lbl">XP</div></div>
    </div>

    <div class="daily" id="daily-btn">
      <div class="daily-icon">üìÖ</div>
      <div>
        <div class="daily-title">Daily Challenge</div>
        <div class="daily-sub" id="daily-sub">20 questions ¬∑ +50 Bonus XP</div>
      </div>
      <div class="daily-arr">‚Üí</div>
    </div>

    <div class="sect"><div class="sect-line"></div><div class="sect-lbl">Game Mode</div><div class="sect-line"></div></div>
    <div class="mode-grid" id="mode-grid">
      <div class="mc sel" data-mode="classic" style="--mc1:var(--violet);--mc2:var(--cyan)">
        <div class="mc-icon">‚ö°</div><div class="mc-name">Classic</div><div class="mc-desc">Race the clock, build streaks</div>
      </div>
      <div class="mc" data-mode="zen" style="--mc1:#00ff87;--mc2:var(--cyan)">
        <div class="mc-icon">üåä</div><div class="mc-name">Zen</div><div class="mc-desc">No timer, pure focus</div>
        <div class="mc-badge" style="background:rgba(0,255,135,.14);color:#00ff87;border:1px solid rgba(0,255,135,.3)">CALM</div>
      </div>
      <div class="mc" data-mode="blitz" style="--mc1:#ff2d78;--mc2:var(--gold)">
        <div class="mc-icon">üí•</div><div class="mc-name">Blitz</div><div class="mc-desc">3 seconds per question</div>
        <div class="mc-badge" style="background:rgba(255,45,120,.14);color:#ff2d78;border:1px solid rgba(255,45,120,.3)">HARD</div>
      </div>
      <div class="mc" data-mode="survival" style="--mc1:var(--gold);--mc2:var(--coral)">
        <div class="mc-icon">üíÄ</div><div class="mc-name">Survival</div><div class="mc-desc">3 lives. How far can you go?</div>
        <div class="mc-badge" style="background:rgba(255,184,0,.14);color:var(--gold);border:1px solid rgba(255,184,0,.3)">NEW</div>
      </div>
    </div>

    <div class="sect"><div class="sect-line"></div><div class="sect-lbl">Difficulty</div><div class="sect-line"></div></div>
    <div class="diff-grid" id="diff-grid"></div>

    <div class="sect"><div class="sect-line"></div><div class="sect-lbl">Operations</div><div class="sect-line"></div></div>
    <div class="ops-row" id="ops-row">
      <button class="ot" data-op="add">+</button>
      <button class="ot" data-op="sub">‚àí</button>
      <button class="ot" data-op="mul">√ó</button>
      <button class="ot" data-op="div">√∑</button>
      <button class="ot" data-op="mod">%</button>
    </div>

    <button class="cta" id="play-btn">‚ñ∂  PLAY NOW</button>

    <div class="sect"><div class="sect-line"></div><div class="sect-lbl">Top Players</div><div class="sect-line"></div></div>
    <div class="lb-box"><div class="lb-hd">LEADERBOARD</div><div id="lb-rows"></div></div>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <div class="gh">
    <button class="gquit" id="quit-btn">‚úï</button>
    <div class="gpills">
      <div class="gp" id="mode-pill">‚ö° CLASSIC</div>
      <div class="gp">LVL&nbsp;<span class="gpv" id="g-lvl">1</span></div>
      <div class="gp sp">üî•&nbsp;<span class="gpv" id="g-streak">0</span></div>
      <div class="gp">‚úì&nbsp;<span class="gpv" id="g-correct">0</span></div>
    </div>
  </div>
  <div class="gbar">
    <div class="bmeta"><span id="g-elapsed">0.0s</span><span id="g-limit"></span></div>
    <div class="btrack"><div class="bfill" id="bfill" style="width:100%"></div></div>
  </div>
  <div class="lives-row" id="lives-row"><span id="lives-disp">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
  <div class="qzone">
    <div class="qmeta">
      <div class="qchip"><div class="qdot"></div><span id="op-name">ADDITION</span></div>
      <div class="qnum">Q&nbsp;<span id="q-num">1</span></div>
    </div>
    <div class="question" id="question"></div>
    <div class="cbar">
      <span class="clbl">COMBO</span>
      <div class="cdots" id="cdots">
        <div class="cd"></div><div class="cd"></div><div class="cd"></div><div class="cd"></div><div class="cd"></div>
      </div>
      <span class="cbonus" id="cbonus"></span>
    </div>
  </div>
  <div class="ans-grid" id="ans-grid"></div>
</div>

<!-- RESULT -->
<div class="screen" id="result">
  <div class="result-inner">
    <div class="rhero">
      <span class="rtrophy" id="r-trophy">üèÜ</span>
      <div class="rtitle" id="r-title">CHAMPION!</div>
      <div class="rrecord" id="r-record">‚ú¶ NEW RECORD ‚ú¶</div>
      <div class="rgrade" id="r-grade">S</div>
    </div>

    <div class="achrow" id="ach-row" style="display:none"></div>

    <div class="rstats">
      <div class="rs hi"><div class="rsv" id="r-streak">0</div><div class="rsl">Best Streak üî•</div></div>
      <div class="rs"><div class="rsv" id="r-correct">0</div><div class="rsl">Correct ‚úì</div></div>
      <div class="rs"><div class="rsv" id="r-acc">0%</div><div class="rsl">Accuracy</div></div>
      <div class="rs"><div class="rsv" id="r-speed">‚Äî</div><div class="rsl">Avg Speed</div></div>
    </div>

    <div class="xpcard">
      <div class="xph">
        <div class="xplvl" id="xp-lvl-lbl">Level 1 Apprentice</div>
        <div class="xpnxt" id="xp-nxt">0 / 200 XP</div>
      </div>
      <div class="xptrack"><div class="xpfill" id="xp-fill"></div></div>
      <div class="xpearned" id="xp-earned">+0 XP earned</div>
    </div>

    <div class="bdown">
      <div class="bdtitle">Performance By Operation</div>
      <div id="bd-rows"></div>
    </div>

    <div class="rbtns">
      <button class="ragain" id="r-again">‚Ü∫ RETRY</button>
      <button class="rhomebtn" id="r-home">‚åÇ</button>
    </div>
    <button class="rshare" id="r-share">üì§&nbsp; SHARE MY SCORE</button>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MATH SAGA ‚Äî ENGINE v3.1
   Fixes:
   - Op toggle listeners wired ONCE at boot, never inside initHome()
   - Mode card listeners wired ONCE at boot
   - Diff button listeners wired ONCE at boot (diff-grid rebuilt only for .sel class)
   - Fixed top bar shown/hidden on home
   - Home icon font size increased
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

var S = {
  get: function(k, d) {
    try { var v = localStorage.getItem('ms3_' + k); return v !== null ? JSON.parse(v) : d; }
    catch(e) { return d; }
  },
  set: function(k, v) {
    try { localStorage.setItem('ms3_' + k, JSON.stringify(v)); } catch(e) {}
  }
};

var OP_NAME  = {add:'ADDITION', sub:'SUBTRACTION', mul:'MULTIPLY', div:'DIVISION', mod:'MODULUS'};
var OP_CHAR  = {add:'+', sub:'‚àí', mul:'√ó', div:'√∑', mod:'%'};
var OP_EMOJI = {add:'‚ûï', sub:'‚ûñ', mul:'‚úñÔ∏è', div:'‚ûó', mod:'üî¢'};
var OP_LABEL = {add:'Addition', sub:'Subtraction', mul:'Multiply', div:'Division', mod:'Modulus'};
var MODE_LABEL = {classic:'‚ö° CLASSIC', zen:'üåä ZEN', blitz:'üí• BLITZ', survival:'üíÄ SURVIVAL'};

var XP_TIERS = [
  {xp:0,    title:'Apprentice'},  {xp:200,  title:'Scholar'},
  {xp:500,  title:'Calculator'},  {xp:1000, title:'Solver'},
  {xp:2000, title:'Genius'},      {xp:4000, title:'Wizard'},
  {xp:7500, title:'Master'},      {xp:12000,title:'Legend'},
  {xp:20000,title:'Champion'},    {xp:35000,title:'Mythic'}
];

var ACHIEVEMENTS = [
  {id:'first',  icon:'üéØ', name:'First Blood',  check: function(st){return st.correct>=1}},
  {id:'s5',     icon:'üî•', name:'On Fire',      check: function(st){return st.bestStreak>=5}},
  {id:'s10',    icon:'üí•', name:'Inferno',      check: function(st){return st.bestStreak>=10}},
  {id:'s20',    icon:'‚ö°', name:'Lightning',    check: function(st){return st.bestStreak>=20}},
  {id:'perf10', icon:'üíé', name:'Perfect 10',   check: function(st){return st.total>=10 && st.correct===st.total}},
  {id:'speed',  icon:'üöÄ', name:'Speed Demon',  check: function(st){
    if(!st.times||!st.times.length) return false;
    var s=0; for(var i=0;i<st.times.length;i++) s+=st.times[i];
    return (s/st.times.length)<2;
  }},
  {id:'cent',   icon:'üíØ', name:'Centurion',    check: function(st){return st.globalCorrect>=100}},
  {id:'allops', icon:'üîÆ', name:'All-Rounder',  check: function(st){
    return ['add','sub','mul','div','mod'].every(function(op){return st.opStats[op].c>0});
  }},
  {id:'blitzm', icon:'üåÄ', name:'Blitz Master', check: function(st){return st.mode==='blitz'&&st.total>=5}},
  {id:'surv',   icon:'üõ°Ô∏è', name:'Survivor',    check: function(st){return st.mode==='survival'&&st.survived}},
];

var G = {
  bestStreak:   S.get('bestStreak', 0),
  totalSolved:  S.get('totalSolved', 0),
  xp:           S.get('xp', 0),
  achievements: S.get('achievements', []),
  dailyDone:    S.get('dailyDone', ''),
  lb:           S.get('lb', [
    {name:'AceCalc',   score:9840},
    {name:'MathWiz',   score:8720},
    {name:'NumbNinja', score:7550},
    {name:'You',       score:0, isYou:true},
  ])
};

var ST = {
  level:1, mode:'classic', ops:['add','sub','mul','div','mod'],
  streak:0, bestStreak:0, correct:0, total:0, combo:0,
  currentOp:'', currentAnswer:0, qStart:0, times:[],
  lives:3, survived:false, isDaily:false, qCount:0,
  opStats:{add:{c:0,t:0},sub:{c:0,t:0},mul:{c:0,t:0},div:{c:0,t:0},mod:{c:0,t:0}},
  timer:null, timeLimitMs:0, locked:false
};

function el(id) { return document.getElementById(id); }
function rand(a,b) { return Math.floor(Math.random()*(b-a+1))+a; }

function showScreen(id) {
  var screens = document.querySelectorAll('.screen');
  for(var i=0;i<screens.length;i++) screens[i].classList.remove('active');
  el(id).classList.add('active');
  // Show/hide the fixed top bar ‚Äî only on home
  var bar = el('home-topbar');
  if(id==='home') bar.classList.remove('hidden-bar');
  else            bar.classList.add('hidden-bar');
}

function shuffle(arr) {
  var a=arr.slice();
  for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;}
  return a;
}

function timeLimit(lvl,mode) {
  if(mode==='zen')   return 999999;
  if(mode==='blitz') return 3000;
  return Math.max(5000,12000-lvl*700);
}

function xpTierIdx(xp) {
  var i=0;
  for(var t=XP_TIERS.length-1;t>=0;t--){if(xp>=XP_TIERS[t].xp){i=t;break;}}
  return i;
}
function xpTitle(xp){return XP_TIERS[xpTierIdx(xp)].title;}
function xpProgress(xp) {
  var i=xpTierIdx(xp), cur=XP_TIERS[i], nxt=XP_TIERS[i+1];
  if(!nxt) return{pct:100,label:'MAX LEVEL'};
  return{pct:Math.min(100,((xp-cur.xp)/(nxt.xp-cur.xp))*100), label:(xp-cur.xp)+' / '+(nxt.xp-cur.xp)+' XP'};
}
function calcXP(st) {
  var xp=st.correct*10+st.bestStreak*5;
  if(st.mode==='blitz')            xp=Math.floor(xp*2);
  if(st.mode==='survival'&&st.survived) xp+=100;
  if(st.isDaily) xp+=50;
  var acc=st.total?st.correct/st.total:0;
  if(acc>=1) xp+=30; else if(acc>=.9) xp+=15;
  return Math.floor(xp);
}

function genQ(op,lvl) {
  var s=lvl,a,b,ans;
  if(op==='add'){a=rand(1,10*s);b=rand(1,10*s);ans=a+b;}
  else if(op==='sub'){b=rand(1,10*s);ans=rand(0,10*s);a=ans+b;}
  else if(op==='mul'){a=rand(1,Math.max(2,5*s));b=rand(1,Math.max(2,5*s));ans=a*b;}
  else if(op==='div'){b=rand(1,Math.max(2,5*s));ans=rand(1,Math.max(2,5*s));a=ans*b;}
  else{b=rand(2,Math.max(3,5*s));ans=rand(0,b-1);a=rand(1,8*s)*b+ans;}
  return{a:a,b:b,ans:ans,op:op};
}

function genChoices(ans) {
  var set=[ans],i=0;
  while(set.length<4&&i++<80){
    var d=rand(1,Math.max(5,Math.ceil(Math.abs(ans)*.4)+3));
    var w=ans+(Math.random()<.5?1:-1)*d;
    if(w!==ans&&set.indexOf(w)===-1) set.push(w);
  }
  var e=1;
  while(set.length<4){if(set.indexOf(ans+e)===-1)set.push(ans+e);e++;}
  return shuffle(set);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ONE-TIME WIRING ‚Äî called once at boot.
   initHome() only updates display values,
   never re-attaches listeners.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function wireHomeControls() {

  // ‚îÄ‚îÄ OPERATION TOGGLES ‚îÄ‚îÄ
  // Sync visual state to ST.ops, then wire click once
  var ots = document.querySelectorAll('.ot');
  for(var o=0;o<ots.length;o++) {
    (function(btn) {
      // set initial visual state
      if(ST.ops.indexOf(btn.dataset.op) > -1) btn.classList.add('on');
      else btn.classList.remove('on');

      btn.addEventListener('click', function(){
        var op = btn.dataset.op;
        var idx = ST.ops.indexOf(op);
        if(idx > -1) {
          if(ST.ops.length > 1) {
            ST.ops.splice(idx, 1);
            btn.classList.remove('on');
          }
        } else {
          ST.ops.push(op);
          btn.classList.add('on');
        }
      });
    })(ots[o]);
  }

  // ‚îÄ‚îÄ MODE CARDS ‚îÄ‚îÄ
  var mcs = document.querySelectorAll('.mc');
  for(var m=0;m<mcs.length;m++) {
    (function(card) {
      card.addEventListener('click', function(){
        ST.mode = card.dataset.mode;
        for(var x=0;x<mcs.length;x++) mcs[x].classList.remove('sel');
        card.classList.add('sel');
      });
    })(mcs[m]);
  }

  // ‚îÄ‚îÄ DIFFICULTY BUTTONS ‚Äî built once, listeners wired once ‚îÄ‚îÄ
  var dg = el('diff-grid');
  dg.innerHTML = '';
  for(var i=1;i<=10;i++) {
    (function(lvl) {
      var b = document.createElement('button');
      b.className = 'db' + (lvl===ST.level?' sel':'');
      b.innerHTML = '<span>'+lvl+'</span><span class="dbar"></span>';
      b.addEventListener('click', function(){
        ST.level = lvl;
        var btns = dg.querySelectorAll('.db');
        for(var j=0;j<btns.length;j++) btns[j].classList.remove('sel');
        b.classList.add('sel');
      });
      dg.appendChild(b);
    })(i);
  }
}

/* initHome ‚Äî only refreshes data display, no listener wiring */
function initHome() {
  el('h-best').textContent   = G.bestStreak;
  el('h-solved').textContent = G.totalSolved;
  el('h-xp').textContent     = G.xp;

  var today = new Date().toDateString();
  if(G.dailyDone === today) {
    el('daily-sub').textContent = '‚úì Completed! Come back tomorrow';
    el('daily-sub').style.color = 'var(--lime)';
  } else {
    el('daily-sub').textContent = '20 questions ¬∑ +50 Bonus XP today';
    el('daily-sub').style.color = '';
  }

  renderLB();
}

function renderLB() {
  var sorted = G.lb.slice();
  for(var i=0;i<sorted.length;i++) {
    if(sorted[i].isYou) sorted[i].score = G.bestStreak*100+G.totalSolved;
  }
  sorted.sort(function(a,b){return b.score-a.score;});
  var medals=['ü•á','ü•à','ü•â'], html='', limit=Math.min(4,sorted.length);
  for(var i=0;i<limit;i++) {
    var r=sorted[i];
    html += '<div class="lb-row">'
      +'<div class="lb-rank'+(i===0?' g':'')+'">'+(medals[i]||('#'+(i+1)))+'</div>'
      +'<div class="lb-name"'+(r.isYou?' style="color:var(--cyan)"':'')+'>'+r.name+(r.isYou?' (You)':'')+'</div>'
      +'<div class="lb-score">'+r.score.toLocaleString()+'</div>'
      +'</div>';
  }
  el('lb-rows').innerHTML = html;
}

// ONBOARDING
var obStep = 0;
function obNext() {
  el('ob'+obStep).classList.remove('active');
  obStep = Math.min(2,obStep+1);
  el('ob'+obStep).classList.add('active');
}
function obFinish() {
  el('onboard').classList.add('gone');
  S.set('onboarded', true);
  showScreen('home');
  initHome();
}

el('obn0').addEventListener('click', obNext);
el('obn1').addEventListener('click', obNext);
el('obn2').addEventListener('click', obFinish);
el('obskip').addEventListener('click', obFinish);

// Wire all home controls once at boot
wireHomeControls();

// If already onboarded, skip straight to home
if(S.get('onboarded', false)) {
  el('onboard').classList.add('gone');
  showScreen('home');
  initHome();
}

// GAME
function startGame() {
  if(!ST.ops.length) return;
  ST.streak=0; ST.bestStreak=0; ST.correct=0; ST.total=0;
  ST.combo=0; ST.times=[]; ST.lives=3; ST.survived=false; ST.qCount=0;
  ST.opStats={add:{c:0,t:0},sub:{c:0,t:0},mul:{c:0,t:0},div:{c:0,t:0},mod:{c:0,t:0}};
  ST.timeLimitMs = timeLimit(ST.level, ST.mode);

  el('g-lvl').textContent     = ST.level;
  el('mode-pill').textContent = MODE_LABEL[ST.mode];
  el('g-limit').textContent   = ST.mode==='zen'?'‚àû':(ST.timeLimitMs/1000).toFixed(0)+'s';

  var lr = el('lives-row');
  lr.style.display = ST.mode==='survival'?'block':'none';
  renderLives();

  showScreen('game');
  nextQ();
}

function renderLives() {
  var s='';
  for(var i=0;i<3;i++) s+=(i<ST.lives?'‚ù§Ô∏è':'üñ§');
  el('lives-disp').textContent=s;
}

function nextQ() {
  if(ST.isDaily && ST.qCount>=20){endGame();return;}
  ST.locked=false;
  ST.qCount++;
  var op=ST.ops[Math.floor(Math.random()*ST.ops.length)];
  var q=genQ(op,ST.level);
  ST.currentOp=op; ST.currentAnswer=q.ans; ST.qStart=performance.now();

  el('op-name').textContent=OP_NAME[op];
  el('q-num').textContent=ST.qCount;
  el('question').innerHTML=
    q.a+' <span class="qop">'+OP_CHAR[op]+'</span> '+q.b+' <span class="qeq">=</span> <span class="qslot">?</span>';

  var choices=genChoices(q.ans);
  var ag=el('ans-grid'); ag.innerHTML='';
  var palettes=[
    ['var(--violet)','var(--cyan)'],
    ['var(--magenta)','var(--violet)'],
    ['var(--cyan)','var(--lime)'],
    ['var(--gold)','var(--coral)']
  ];
  for(var i=0;i<choices.length;i++) {
    (function(val,idx){
      var b=document.createElement('button');
      b.className='ans';
      b.style.cssText='--ac1:'+palettes[idx][0]+';--ac2:'+palettes[idx][1];
      b.innerHTML='<span class="ans-t">'+val+'</span>';
      b.addEventListener('click',function(){handleAns(val,b,q.ans);});
      ag.appendChild(b);
    })(choices[i],i);
  }

  el('g-streak').textContent=ST.streak;
  el('g-correct').textContent=ST.correct;
  updateCombo();
  startTimer();
}

function startTimer() {
  clearInterval(ST.timer);
  var fill=el('bfill'), elapEl=el('g-elapsed');
  var start=performance.now(), lim=ST.timeLimitMs;
  fill.style.width='100%'; fill.classList.remove('danger');
  if(ST.mode==='zen'){elapEl.textContent='‚àû';return;}
  ST.timer=setInterval(function(){
    var e=performance.now()-start, pct=Math.max(0,1-e/lim);
    fill.style.width=(pct*100)+'%';
    elapEl.textContent=(e/1000).toFixed(1)+'s';
    if(pct<.25) fill.classList.add('danger');
    if(pct<=0){clearInterval(ST.timer);onTimeout();}
  },50);
}

function onTimeout() {
  if(ST.locked) return;
  ST.locked=true;
  var btns=el('ans-grid').querySelectorAll('.ans');
  for(var i=0;i<btns.length;i++){
    btns[i].disabled=true;
    if(Number(btns[i].querySelector('.ans-t').textContent)===ST.currentAnswer)
      btns[i].classList.add('reveal');
  }
  wrongFX();
  ST.total++;
  var os=ST.opStats[ST.currentOp]; os.c++;
  ST.combo=0; ST.streak=0;
  el('g-streak').textContent=ST.streak; el('g-correct').textContent=ST.correct;
  updateCombo();
  if(ST.mode==='survival'){
    ST.lives--; renderLives();
    if(ST.lives<=0){setTimeout(endGame,900);return;}
  }
  setTimeout(nextQ,900);
}

function handleAns(val,btn,correct) {
  if(ST.locked) return;
  ST.locked=true;
  clearInterval(ST.timer);
  var elapsed=(performance.now()-ST.qStart)/1000, ok=(val===correct);
  var btns=el('ans-grid').querySelectorAll('.ans');
  for(var i=0;i<btns.length;i++){
    btns[i].disabled=true;
    if(Number(btns[i].querySelector('.ans-t').textContent)===correct)
      btns[i].classList.add(ok?'correct':'reveal');
  }
  if(!ok) btn.classList.add('wrong');
  ST.total++;
  var os=ST.opStats[ST.currentOp]; os.t+=elapsed; os.c++;
  ST.times.push(elapsed);
  if(ok){
    ST.combo=Math.min(5,ST.combo+1);
    ST.streak++; ST.correct++;
    ST.bestStreak=Math.max(ST.bestStreak,ST.streak);
    correctFX(btn);
    floatScore(btn,'+'+scoreForAns(elapsed));
    if(ST.streak>0&&ST.streak%5===0) streakPop(ST.streak);
  } else {
    ST.combo=0; ST.streak=0;
    wrongFX();
    if(ST.mode==='survival'){
      ST.lives--; renderLives();
      if(ST.lives<=0){setTimeout(endGame,900);return;}
    }
  }
  el('g-streak').textContent=ST.streak; el('g-correct').textContent=ST.correct;
  updateCombo();
  setTimeout(nextQ,ok?500:850);
}

function scoreForAns(t) {
  var speed=Math.max(0,(3-t)/3), combo=ST.combo>=5?2:ST.combo>=3?1.5:1;
  return Math.round(10*combo*(1+speed));
}

function correctFX(btn) {
  var f=el('flash'); f.className=''; void f.offsetWidth; f.className='c';
  spawnParticles(btn,'#00ff87');
  try{if(navigator.vibrate)navigator.vibrate([15,10,15]);}catch(e){}
}
function wrongFX() {
  var f=el('flash'); f.className=''; void f.offsetWidth; f.className='w';
  try{if(navigator.vibrate)navigator.vibrate(90);}catch(e){}
}

function spawnParticles(ref,color) {
  var r=ref.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
  var p=el('particles');
  for(var i=0;i<12;i++){
    var d=document.createElement('div');
    d.className='pfly';
    var angle=(Math.PI*2*i/12)+Math.random()*.5, dist=50+Math.random()*65, sz=4+Math.random()*5;
    d.style.cssText='left:'+cx+'px;top:'+cy+'px;width:'+sz+'px;height:'+sz+'px;'
      +'background:'+color+';box-shadow:0 0 6px '+color+';'
      +'--dx:'+(Math.cos(angle)*dist)+'px;--dy:'+(Math.sin(angle)*dist)+'px;';
    p.appendChild(d);
    setTimeout(function(){if(d.parentNode)d.parentNode.removeChild(d);},700);
  }
}

function floatScore(ref,txt) {
  var r=ref.getBoundingClientRect();
  var div=document.createElement('div');
  div.className='sfloat'; div.textContent=txt;
  div.style.left=(r.left+r.width/2-20)+'px'; div.style.top=r.top+'px';
  document.body.appendChild(div);
  setTimeout(function(){if(div.parentNode)div.parentNode.removeChild(div);},660);
}

function streakPop(n) {
  var msgs={5:'üî• 5 STREAK!',10:'üí• 10 STREAK!',15:'‚ö° 15 STREAK!',20:'üåü 20 STREAK!',25:'üëë 25 STREAK!'};
  var div=document.createElement('div');
  div.className='spop'; div.textContent=msgs[n]||('üî• '+n+' STREAK!');
  document.body.appendChild(div);
  setTimeout(function(){if(div.parentNode)div.parentNode.removeChild(div);},750);
}

function updateCombo() {
  var dots=el('cdots').querySelectorAll('.cd');
  for(var i=0;i<dots.length;i++) dots[i].classList.toggle('on',i<ST.combo);
  var cb=el('cbonus');
  if(ST.combo>=5){cb.textContent='√ó2 üî•';cb.classList.add('show');}
  else if(ST.combo>=3){cb.textContent='√ó1.5';cb.classList.add('show');}
  else{cb.classList.remove('show');}
}

el('quit-btn').addEventListener('click',function(){clearInterval(ST.timer);endGame();});

function endGame() {
  clearInterval(ST.timer);
  if(ST.mode==='survival'&&ST.lives>0) ST.survived=true;
  showResult();
}

function showResult() {
  var wasRecord=ST.bestStreak>G.bestStreak;
  G.bestStreak=Math.max(G.bestStreak,ST.bestStreak);
  G.totalSolved+=ST.correct;
  var xpEarned=calcXP(ST);
  G.xp+=xpEarned;
  if(ST.isDaily){G.dailyDone=new Date().toDateString();S.set('dailyDone',G.dailyDone);}
  S.set('bestStreak',G.bestStreak); S.set('totalSolved',G.totalSolved); S.set('xp',G.xp);

  var newAch=[];
  var chk={correct:ST.correct,total:ST.total,bestStreak:ST.bestStreak,times:ST.times,
    mode:ST.mode,survived:ST.survived,opStats:ST.opStats,globalCorrect:G.totalSolved};
  for(var i=0;i<ACHIEVEMENTS.length;i++){
    var a=ACHIEVEMENTS[i];
    if(G.achievements.indexOf(a.id)===-1&&a.check(chk)){G.achievements.push(a.id);newAch.push(a);}
  }
  S.set('achievements',G.achievements);

  var pct=ST.total?ST.correct/ST.total:0;
  var trophy='üíÄ',title='TRY AGAIN',grade='F';
  if(pct>=.97){trophy='üëë';title='LEGENDARY!';grade='S+';}
  else if(pct>=.9){trophy='üèÜ';title='CHAMPION!';grade='S';}
  else if(pct>=.8){trophy='üåü';title='EXCELLENT!';grade='A';}
  else if(pct>=.7){trophy='üëç';title='GREAT RUN!';grade='B';}
  else if(pct>=.5){trophy='‚úåÔ∏è';title='GOOD EFFORT';grade='C';}
  if(ST.mode==='survival'&&ST.survived){trophy='üõ°Ô∏è';title='SURVIVED!';grade='S';}

  el('r-trophy').textContent=trophy; el('r-title').textContent=title; el('r-grade').textContent=grade;
  el('r-record').classList.toggle('show',wasRecord);
  el('r-streak').textContent=ST.bestStreak; el('r-correct').textContent=ST.correct;
  el('r-acc').textContent=ST.total?Math.round(pct*100)+'%':'0%';
  var sum=0; for(var i=0;i<ST.times.length;i++) sum+=ST.times[i];
  el('r-speed').textContent=ST.times.length?(sum/ST.times.length).toFixed(1)+'s':'‚Äî';

  var xpP=xpProgress(G.xp), ti=xpTierIdx(G.xp);
  el('xp-lvl-lbl').textContent='Level '+(ti+1)+' '+xpTitle(G.xp);
  el('xp-nxt').textContent=xpP.label;
  el('xp-earned').textContent='+'+xpEarned+' XP earned'+(ST.isDaily?' (daily bonus)':'');
  setTimeout(function(){el('xp-fill').style.width=xpP.pct+'%';},150);

  var ar=el('ach-row');
  ar.style.display=newAch.length?'flex':'none';
  var achHTML='';
  for(var i=0;i<newAch.length;i++)
    achHTML+='<div class="ach" style="animation-delay:'+(i*.1)+'s"><span class="ach-icon">'+newAch[i].icon+'</span>'+newAch[i].name+'</div>';
  ar.innerHTML=achHTML;

  var activeOps=[],opKeys=['add','sub','mul','div','mod'];
  for(var i=0;i<opKeys.length;i++)
    if(ST.ops.indexOf(opKeys[i])>-1&&ST.opStats[opKeys[i]].c>0) activeOps.push(opKeys[i]);
  var maxC=1;
  for(var i=0;i<activeOps.length;i++) if(ST.opStats[activeOps[i]].c>maxC) maxC=ST.opStats[activeOps[i]].c;
  var bdHTML='';
  if(activeOps.length){
    for(var i=0;i<activeOps.length;i++){
      var op=activeOps[i],s=ST.opStats[op],pBar=Math.round((s.c/maxC)*100);
      bdHTML+='<div class="bdrow"><span class="bdicon">'+OP_EMOJI[op]+'</span>'
        +'<span class="bdlbl">'+OP_LABEL[op]+'</span>'
        +'<div class="bdtrack"><div class="bdfill" style="width:'+pBar+'%"></div></div>'
        +'<span class="bdacc">'+s.c+'‚úì</span></div>';
    }
  } else {
    bdHTML='<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:8px 0">No data yet</div>';
  }
  el('bd-rows').innerHTML=bdHTML;

  for(var i=0;i<G.lb.length;i++)
    if(G.lb[i].isYou) G.lb[i].score=Math.max(G.lb[i].score||0,G.bestStreak*100+G.totalSolved);
  S.set('lb',G.lb);

  showScreen('result');
}

el('r-share').addEventListener('click',function(){
  var txt='üßÆ Math Saga ‚Äî '+ST.correct+'/'+ST.total+' correct ¬∑ '+ST.bestStreak+' streak! #MathSaga';
  if(navigator.share){navigator.share({title:'Math Saga',text:txt,url:location.href}).catch(function(){});}
  else if(navigator.clipboard){
    navigator.clipboard.writeText(txt).then(function(){
      el('r-share').textContent='‚úì Copied to clipboard!';
      setTimeout(function(){el('r-share').innerHTML='üì§&nbsp; SHARE MY SCORE';},2200);
    });
  }
});

el('play-btn').addEventListener('click',  function(){if(ST.ops.length)startGame();});
el('daily-btn').addEventListener('click', function(){ST.isDaily=true;startGame();});
el('r-again').addEventListener('click',   function(){ST.isDaily=false;startGame();});
el('r-home').addEventListener('click',    function(){ST.isDaily=false;showScreen('home');initHome();});
</script>

<script>
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(function(){});
</script>
</body>
</html>
